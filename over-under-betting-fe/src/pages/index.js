import Head from 'next/head'
import Link from 'next/link'
import dynamic from 'next/dynamic'
import React, { useState } from "react"
import { Inter } from 'next/font/google'

import HomeComponent from '@/components/HomeComponent'
import Markets from '@/components/Markets'
import Docs from '@/components/Docs'


import { 
  get_all_hourly_price_data, 
  get_current_six_hour_event_data,
  get_current_test_event_data 
} from '@/utils/api_calls/over_under_api_calls'
import { ETHProvider} from '@/utils/eth/ethereum_provider';

const inter = Inter({ subsets: ['latin'] })

const ConnectWalletButton = dynamic(() => import('@/components/ConnectWalletButton'), {
  loading: () => <p>Loading...</p>,
  ssr: false
});

const UserDashboard = dynamic(() => import('@/components/UserDashboard'), {
  loading: () => <p>Loading...</p>,
  ssr: false
});

const Home = ({ server_data }) => {
  const btc_data = server_data['btc'];
  const eth_data = server_data['eth'];
  const contract_data = server_data['events'];
  const provider_url = server_data['provider_url'];

  const eth_provider = new ETHProvider(provider_url);

  const [btnSelection, setBtnSelection] = useState('home');

  function handleClick(selection) {
    if (selection == 'home' && btnSelection != 'home') {
      setBtnSelection('home');
    } else if (selection == 'markets' && btnSelection != 'markets') {
      setBtnSelection('markets');
    } else if (selection == 'dashboard' && btnSelection != 'dashboard') {
      setBtnSelection('dashboard');
    } else if (selection == 'docs' && btnSelection != 'docs') {
      setBtnSelection('docs');
    }
  }

  return (
    <>
      <Head>
        <title>Over-Under-Betting</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <div className="home-container container m-auto">
        <div className="navbar row navigation m-auto mt-3 justify-content-center align-items-center">
          <div className='col-sm-1 me-3 d-flex justify-content-center align-items-center'>
            <button onClick={() => handleClick('home')} variant="primary" title='Home' className="nav-link-button btn btn-dark btn-lg">
              <i className="bi bi-house-door"></i>
            </button>
          </div>
          <div className='col-sm-1 me-3 d-flex justify-content-center align-items-center'>
            <button onClick={() => handleClick('markets')} variant="primary" title='Browse Markets' className="nav-link-button btn btn-dark btn-lg">
              <i className="bi bi-graph-up"></i>
            </button>
          </div>
          <div className='col-sm-1  me-3 d-flex justify-content-center align-items-center'>
            <button onClick={() => handleClick('docs')} variant="primary" title='Docs' className="nav-link-button btn btn-dark btn-lg m-auto-2">
              <i className="bi bi-file-text-fill"></i>
            </button>
          </div>
          <div className='col-sm-1  me-3 d-flex justify-content-center align-items-center'>
            <button onClick={() => handleClick('dashboard')} variant="primary" title='Manage participated events' className="nav-link-button btn btn-dark btn-lg m-auto-2">
              <i className="bi bi-columns-gap"></i>
            </button>
          </div>
          <div className='col-sm-1 me-3 d-flex justify-content-center align-items-center'>
            <ConnectWalletButton />
          </div>
        </div>

        <div className="container-fluid m-auto">
          {btnSelection == 'home' && <HomeComponent server_data={server_data} eth_provider={eth_provider} />}
          {btnSelection == 'markets' && <Markets />}
          {btnSelection == 'dashboard' && <UserDashboard eth_provider={eth_provider} />}
          {btnSelection == 'docs' && <Docs />}
        </div>

        <div className="row social-navbar m-auto mt-3 justify-content-center align-items-center">
          <div className="col-sm-1 d-flex justify-content-center align-items-center">
            <Link href="https://linkedin.com/in/james-lynch-14645911a">
              <button title="LinkedIn" variant="primary" className="nav-link-button mb-1">
                <i className="bi bi-linkedin"></i>
              </button>
            </Link>
          </div>
          <div className="col-sm-1 d-flex justify-content-center align-items-center">
            <Link href="https://github.com/j1m5s3">
              <button title="GitHub" variant="primary" className="nav-link-button mb-1">
                <i className="bi bi-github"></i>
              </button>
            </Link>
          </div>
        </div>

      </div>
    </>
  )
}

// For now just get data for charts
export const getServerSideProps = async () => {
  var btc_price_error = false;
  var eth_price_error = false;
  var contract_data_error = false;
  const provider_url = process.env.NEXT_SEPOLIA_URL;

  var price_data = await get_all_hourly_price_data(24);

  var contract_data;
  if (process.env.NEXT_PUBLIC_ENV == 'development') {
    contract_data = await get_current_test_event_data();
  }
  else {
    contract_data = await get_current_six_hour_event_data();
  }

  if (price_data.btc.length == 0) {
    btc_price_error = true;
  }
  if (price_data.eth.length == 0) {
    eth_price_error = true;
  }
  if (Object.keys(contract_data).length == 0) {
    contract_data_error = true;
  }
  

  const server_data = {
    btc: {
      data: price_data.btc, 
      error: btc_price_error
    },
    eth: {
      data: price_data.eth, 
      error: eth_price_error
    },
    events: {
      data: contract_data, 
      error: contract_data_error
    },
    provider_url: provider_url
  }

  return {
    props: { server_data }
  };
};

export default Home;
